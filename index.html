<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wanzofc Quiz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; flex-direction: column; }
        #app { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 90%; max-width: 650px; text-align: center; margin: 20px auto; position: relative; }
        h1, h2 { color: #2e86de; }
        .button { background-color: #2e86de; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 8px; font-size: 1em; transition: background-color 0.3s ease; }
        .button:hover { background-color: #1b4f72; }
        #user-info { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid #2e86de; }
        #logout-btn { position: absolute; top: 15px; right: 15px; background-color: #dc3545; }
        #logout-btn:hover { background-color: #c82333; }
        #lobby, #room { display: none; }
        #leaderboard, #public-rooms { margin-top: 20px; }
        #leaderboard-list, #players-list, #public-rooms-list { list-style: none; padding: 0; }
        #leaderboard-list li, #players-list li, #public-rooms-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        #public-rooms-list li { background-color: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
        #players-list img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .join-btn-small { padding: 5px 10px; font-size: 0.9em; }
        .swal2-select { display: block !important; width: 80% !important; margin: 10px auto !important; padding: 0.75em !important; border-radius: 6px; border: 1px solid #ddd; }
        .profile-btn { padding: 8px 12px; font-size: 0.9em; margin-left: 15px; background-color: #17a2b8; border-radius: 50px; }
        .profile-btn:hover { background-color: #138496; }
    </style>
</head>
<body>
    <div id="app">
        <h1><i class="fas fa-gamepad"></i> Wanzofc Quiz</h1>
        <button class="button" id="logout-btn"><i class="fas fa-sign-out-alt"></i></button>

        <!-- Lobby -->
        <div id="lobby">
            <div id="user-info">
                <img id="user-profile-pic" src="default-avatar.png" alt="Profile Pic" class="profile-pic">
                <span id="username-display"></span>
                <a href="/profile.html" class="button profile-btn"><i class="fas fa-user"></i></a>
            </div>
            <h2>Lobby</h2>
            <button class="button" id="create-room-btn"><i class="fas fa-plus-circle"></i> Create Room</button>
            <input type="text" id="room-id-input" placeholder="Room ID">
            <button class="button" id="join-room-btn"><i class="fas fa-sign-in-alt"></i> Join Room</button>

            <div id="public-rooms">
                <h3>Public Rooms</h3>
                <ul id="public-rooms-list"></ul>
            </div>

            <div id="leaderboard">
                <h3>Leaderboard</h3>
                <ul id="leaderboard-list"></ul>
            </div>
        </div>

        <!-- Room -->
        <div id="room">
            <h2 id="room-name"></h2>
            <p>Room ID: <span id="room-id-display"></span></p>
            <p>Players:</p>
            <ul id="players-list"></ul>
            <button class="button" id="leave-room-btn"><i class="fas fa-sign-out-alt"></i> Leave Room</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ autoConnect: false });

        // DOM Elements
        const lobby = document.getElementById('lobby');
        const room = document.getElementById('room');
        const logoutBtn = document.getElementById('logout-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const leaderboardList = document.getElementById('leaderboard-list');
        const playersList = document.getElementById('players-list');
        const publicRoomsList = document.getElementById('public-rooms-list');
        const roomNameDisplay = document.getElementById('room-name');
        const roomIdDisplay = document.getElementById('room-id-display');
        const usernameDisplay = document.getElementById('username-display');
        const userProfilePic = document.getElementById('user-profile-pic');

        let currentRoomId = null;

        function showLobby() {
            lobby.style.display = 'block';
            room.style.display = 'none';
            currentRoomId = null;
            socket.emit('getLeaderboard');
            socket.emit('getPublicRooms');
        }

        function showRoom(roomId) {
            lobby.style.display = 'none';
            room.style.display = 'block';
            currentRoomId = roomId;
        }

        function displayError(message) {
            Swal.fire({ icon: 'error', title: 'Oops...', text: message });
        }

        socket.on('connect', () => console.log('Socket connected:', socket.id));

        socket.on('connectionSuccess', (data) => {
            console.log('Authenticated successfully.');
            usernameDisplay.textContent = `Welcome, ${data.username}!`;
            userProfilePic.src = data.profilePic || 'default-avatar.png';
            showLobby();
        });

        socket.on('leaderboardUpdate', (leaderboard) => {
            leaderboardList.innerHTML = leaderboard.map(user =>
                `<li><img src="${user.profilePic}" alt="${user.username}" class="profile-pic" style="width:25px;height:25px;"><span>${user.username}</span><span>${user.totalScore}</span></li>`
            ).join('');
        });

        socket.on('publicRoomsUpdate', (rooms) => {
            if (rooms.length === 0) {
                publicRoomsList.innerHTML = '<li>No public rooms available. Create one!</li>';
                return;
            }
            publicRoomsList.innerHTML = rooms.map(r => `
                <li>
                    <span>${r.name} (${r.playerCount}/${r.maxPlayers})</span>
                    <button class="button join-btn-small" data-roomid="${r.id}">Join</button>
                </li>
            `).join('');
        });

        socket.on('roomInfo', (data) => {
            roomNameDisplay.textContent = data.roomName;
            roomIdDisplay.textContent = data.roomId;
            playersList.innerHTML = data.users.map(user =>
                `<li><img src="${user.profilePic}" alt="${user.username}" class="profile-pic"><span>${user.username}</span><span>Score: ${user.score}</span></li>`
            ).join('');
        });

        socket.on('disconnect', () => {
            displayError('You have been disconnected. Please login again.');
            setTimeout(() => window.location.href = '/', 2000);
        });

        logoutBtn.addEventListener('click', () => window.location.href = '/logout');

        createRoomBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('https://opentdb.com/api_category.php');
                if (!response.ok) throw new Error('Failed to fetch categories');
                const data = await response.json();
                const categories = data.trivia_categories;

                const categoryOptions = categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');

                const { value: formValues } = await Swal.fire({
                    title: 'Create a New Room',
                    html:
                        '<input id="swal-room-name" class="swal2-input" placeholder="Room Name (optional)">' +
                        `<select id="swal-category" class="swal2-select"><option value="">Any Category</option>${categoryOptions}</select>` +
                        '<select id="swal-difficulty" class="swal2-select">' +
                            '<option value="">Any Difficulty</option>' +
                            '<option value="easy">Easy</option>' +
                            '<option value="medium">Medium</option>' +
                            '<option value="hard">Hard</option>' +
                        '</select>',
                    focusConfirm: false,
                    preConfirm: () => {
                        return {
                            roomName: document.getElementById('swal-room-name').value,
                            category: document.getElementById('swal-category').value,
                            difficulty: document.getElementById('swal-difficulty').value
                        }
                    }
                });

                if (formValues) {
                    socket.emit('createRoom', formValues, (response) => {
                        if (response.success) {
                            showRoom(response.roomId);
                        } else {
                            displayError(response.message);
                        }
                    });
                }
            } catch (error) {
                console.error('Error creating room:', error);
                displayError('Could not load room creation options. Please try again.');
            }
        });

        joinRoomBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim().toUpperCase();
            if (roomId) {
                socket.emit('joinRoom', roomId, (response) => {
                    if (response.success) showRoom(roomId);
                    else displayError(response.message);
                });
            } else {
                Swal.fire({ icon: 'warning', text: 'Please enter a room ID.' });
            }
        });

        publicRoomsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('join-btn-small')) {
                const roomId = event.target.dataset.roomid;
                socket.emit('joinRoom', roomId, (response) => {
                    if (response.success) showRoom(roomId);
                    else displayError(response.message);
                });
            }
        });

        leaveRoomBtn.addEventListener('click', () => {
            socket.emit('leaveRoom');
            showLobby();
        });

        socket.connect();
    </script>
</body>
</html>
